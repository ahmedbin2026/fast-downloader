name: ğŸš€ Secure Public Downloader

on:
  repository_dispatch:
    types: [download_task]

jobs:
  secure_download:
    runs-on: ubuntu-latest
    
    # Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±ØªÙƒ Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© (ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
    container:
      image: ghcr.io/ahmedbin2026/pupilc-downloader:latest

    steps:
    # 1. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù† Ø§Ù„Ø®Ø²Ù†Ø© Ø§Ù„Ø¢Ù…Ù†Ø© (Secrets)
    # Ù„Ø§ Ø£Ø­Ø¯ ÙŠØ±Ù‰ Ù…Ø­ØªÙˆÙ‰ Secrets Ù‡Ù†Ø§ØŒ Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙ‚Ø· ÙŠÙ‚ÙˆÙ… Ø¨Ø­Ù‚Ù†Ù‡Ø§
    - name: ğŸ”“ Restore Secrets
      run: |
        mkdir -p ~/.config
        
        # Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        echo '${{ secrets.TELEGRAM_CONFIG }}' > ~/.config/telegram-upload.json
        
        # ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ¥Ø¹Ø§Ø¯ØªÙ‡Ø§ Ù„Ù…Ù„ÙÙ‡Ø§ Ø§Ù„Ø£ØµÙ„ÙŠ
        echo '${{ secrets.TELEGRAM_SESSION }}' | base64 -d > ~/.config/telegram-upload.session
        
        echo "âœ… Session restored securely."

    # 2. ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„Ù…ÙØ§ØªÙŠØ­ ØªØ£ØªÙŠ Ù…Ù† API Payload ÙÙ„Ø§ ØªØ®Ø²Ù† ÙÙŠ Ø§Ù„ÙƒÙˆØ¯)
    - name: ğŸ¬ Run Download Process
      run: |
        # Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø´ØºÙ„ (API)
        URL="${{ github.event.client_payload.url }}"
        KEY="${{ github.event.client_payload.key }}"
        NAME="${{ github.event.client_payload.name }}"
        AGENT="${{ github.event.client_payload.agent }}"
        
        echo "Starting secure job for: $NAME"
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø© (RE Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù€ Docker)
        RE "$URL" \
          --key "$KEY" \
          --save-name "$NAME" \
          -M format=mp4 \
          --decryption-binary-path mp4decrypt \
          --header "User-Agent: $AGENT" \
          --tmp-dir ./tmp

    # 3. Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ø­Ø°Ù
    - name: ğŸ“¤ Upload to Telegram
      run: |
        NAME="${{ github.event.client_payload.name }}"
        FILE=$(find . -name "$NAME*.mp4" | head -n 1)
        
        if [ -f "$FILE" ]; then
           # Ø£Ø¯Ø§Ø© Ø§Ù„Ø±ÙØ¹ Ø³ØªÙ‚Ø±Ø£ Ù…Ù„Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø°ÙŠ Ø§Ø³ØªØ¹Ø¯Ù†Ø§Ù‡ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© 1
           telegram-upload "$FILE"
           echo "âœ… Upload Complete"
        else
           echo "âŒ File missing"
           exit 1
        fi